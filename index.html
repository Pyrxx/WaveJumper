<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tracklist with Interactive Waveform Audio Player</title>
  <style>
    /* ==========================================================================
       CSS Reset (Eric Meyer v2.0 adapted)
       ----------------------------------------------------------------------------
       Neutralizes default browser styles for consistency across browsers.
       Source: https://meyerweb.com/eric/tools/css/reset/
    ========================================================================== */
    html, body, div, span, applet, object, iframe,
    h1, h2, h3, h4, h5, h6, p, blockquote, pre,
    a, abbr, acronym, address, big, cite, code,
    del, dfn, em, img, ins, kbd, q, s, samp,
    small, strike, strong, sub, sup, tt, var,
    b, u, i, center,
    dl, dt, dd, ol, ul, li,
    fieldset, form, label, legend,
    table, caption, tbody, tfoot, thead, tr, th, td,
    article, aside, canvas, details, embed,
    figure, figcaption, footer, header, hgroup,
    menu, nav, output, ruby, section, summary,
    time, mark, audio, video {
      margin: 0;
      padding: 0;
      border: 0;
      font-size: 100%;
      font: inherit;
      vertical-align: baseline;
      outline: 0;
    }
    /* HTML5 display role reset for older browsers */
    article, aside, details, figcaption, figure,
    footer, header, hgroup, menu, nav, section {
      display: block;
    }
    body {
      line-height: 1;
      font-family: Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background: var(--background);
      color: var(--text-color-bright);
    }
    ol, ul {
      list-style: none;
    }
    blockquote, q {
      quotes: none;
    }
    blockquote::before, blockquote::after,
    q::before, q::after {
      content: '';
      content: none;
    }
    table {
      border-collapse: collapse;
      border-spacing: 0;
    }

    /* ==========================================================================
       Theme Variables & Auto Dark Mode by System Preference
       ----------------------------------------------------------------------------
       Define base variables; auto switch for light/dark mode via @media (prefers-color-scheme).
       Benefits: cleaner code, easy theming, no JS needed for theme detection.
    ========================================================================== */
    :root {
      /* Buttons */
      --btn-bg: #383351;
      --btn-color: #fff;
      --btn-hover-bg: #4f4a85;

      /* Text colors */
      --text-color-muted: #555;
      --text-color-bright: #222;

      /* Background */
      --footer-bg: #eee;
      --background: #fff;

      /* Waveform colors */
      --waveform-active: var(--btn-bg);
      --waveform-inactive: var(--text-color-muted);
      --waveform-hover: #fff100;

      /* Spacing & sizing */
      --content-width: 460px;
      --btn-size: 38px;
      --font-family-base: Arial, sans-serif;

      /* Transitions */
      --transition-default: 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --btn-bg: #a3a3e3;
        --btn-color: #222;
        --btn-hover-bg: #8a8aea;

        --text-color-muted: #ccc;
        --text-color-bright: #f0f0f0;

        --footer-bg: #222;
        --background: #121212;

        --waveform-active: var(--btn-bg);
        --waveform-inactive: var(--text-color-muted);
        --waveform-hover: #ffff70;
      }
    }

    /* ==========================================================================
       Layout & Core Components
    ========================================================================== */
    .content {
      width: var(--content-width);
      margin: 0 auto 32px auto;
      box-sizing: border-box;
      user-select: none;
      display: flex;
      flex-direction: column;
      justify-content: center; /* vertical centering */
    }

    #playlist-container {
      width: 100%;
      box-sizing: border-box;
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
      padding-bottom: 80px; /* reserve space for footer */
    }

    .track-item.content {
      display: flex;
      flex-direction: column;
      width: var(--content-width);
      box-sizing: border-box;
      justify-content: center;
    }

    .track-cover-container {
      width: 100%;
      margin-bottom: 8px;
    }
    .track-cover-container img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      display: block;
      user-select: none;
      pointer-events: none;
    }

    .track-info-container {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      box-sizing: border-box;
      margin-bottom: 8px;
      position: relative;
    }

    .play-btn-container {
      flex: 0 0 auto;
      margin: 0;
      padding: 0;
    }

    .btn-play-pause {
      background: var(--btn-bg);
      color: var(--btn-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      width: var(--btn-size);
      height: var(--btn-size);
      padding: 0;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1rem;
      transition: background-color var(--transition-default);
    }
    .btn-play-pause:hover,
    .btn-play-pause:focus-visible {
      background: var(--btn-hover-bg);
      outline-offset: 2px;
      outline: 2px solid var(--btn-hover-bg);
    }

    .artist-title-container {
      flex: 1 1 auto;
      margin: 0 8px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      overflow: hidden;
      min-width: 0;
      user-select: none;
    }
    .track-artist {
      font-weight: 400;
      font-size: 16px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
      color: var(--text-color-muted);
    }
    .track-title {
      font-weight: 700;
      font-size: 18px;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-color-bright);
    }

    .meta-info-container {
      flex: 0 0 auto;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: flex-end;
      user-select: none;
      max-height: 100%;
      box-sizing: border-box;
    }

    .genre-date-row {
      display: flex;
      gap: 12px;
      font-weight: 300;
      font-size: 0.9rem;
      white-space: nowrap;
      color: var(--text-color-muted);
    }

    .time-row {
      font-family: monospace;
      letter-spacing: 0.04em;
      min-width: 138px;
      justify-content: flex-end;
      color: var(--text-color-muted);
      font-weight: 300;
      font-size: 0.9rem;
      margin-top: auto;
      display: flex;
      gap: 6px;
      white-space: nowrap;
      align-items: center;
    }

    .time-row .separator {
      user-select: none;
    }

    .waveform-container {
      width: 100%;
      margin-bottom: 8px;
      user-select: none;
      border-radius: 8px;
      overflow: hidden;
    }

    canvas.waveform-canvas {
      width: 100%;
      height: 110px;
      display: block;
      cursor: pointer;
      border-radius: 8px;
      background: transparent;
    }

    .tracklist-container {
      width: 100%;
      margin-top: 0;
      user-select: none;
    }

    .btn-toggle-tracklist {
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--text-color-muted);
      font-weight: 300;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
      width: 100%;
      justify-content: center;
      padding: 0;
      transition: transform var(--transition-default);
    }

    .btn-toggle-tracklist::after {
      content: '▼';
      font-size: 0.6rem;
      transition: transform var(--transition-default);
    }
    .btn-toggle-tracklist[aria-expanded="true"]::after {
      transform: rotate(-180deg);
    }

    .tracklist-content {
      display: none;
      margin-top: 8px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 150px;
      overflow-y: auto;
      color: var(--text-color-muted);
      width: 100%;
    }
    .tracklist-content.visible {
      display: block;
    }

    /* ==========================================================================
       Footer Controls
    ========================================================================== */
    #footer-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background-color: var(--footer-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      user-select: none;
      z-index: 1000;
      padding: 0 20px;
    }
    #footer-controls .footer-inner-container {
      width: var(--content-width);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    #footer-controls .btn-play-pause {
      padding: 0;
      font-size: 1.1rem;
      min-width: var(--btn-size);
      cursor: pointer;
      background: var(--btn-bg);
      border: none;
      border-radius: 4px;
      color: var(--btn-color);
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      width: var(--btn-size);
      height: var(--btn-size);
      transition: background-color var(--transition-default);
    }

    #footer-controls .btn-play-pause:hover,
    #footer-controls .btn-play-pause:focus-visible {
      background: var(--btn-hover-bg);
      outline-offset: 2px;
      outline: 2px solid var(--btn-hover-bg);
    }

    #footer-controls input[type=range] {
      width: 120px;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-color: var(--background);
      height: 20px;
      border-radius: 5px;
      position: relative;
      overflow: hidden;
      --vol-percent: 100%;
      transition: background var(--transition-default);
    }
    #footer-controls input[type=range]::-webkit-slider-runnable-track {
      height: 20px;
      background: linear-gradient(to right,
        var(--btn-bg) 0%, var(--btn-bg) var(--vol-percent),
        var(--background) var(--vol-percent), var(--background) 100%);
      border-radius: 5px;
    }
    #footer-controls input[type=range]::-moz-range-track {
      height: 20px;
      background: linear-gradient(to right,
        var(--btn-bg) 0%, var(--btn-bg) var(--vol-percent),
        var(--background) var(--vol-percent), var(--background) 100%);
      border-radius: 5px;
      border: none;
    }
    /* Hide slider thumb/knob */
    #footer-controls input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 0;
      height: 0;
      border: none;
      background: transparent;
      cursor: pointer;
    }
    #footer-controls input[type=range]::-moz-range-thumb {
      width: 0;
      height: 0;
      border: none;
      background: transparent;
      cursor: pointer;
    }

    /* SVG icon sizing */
    svg.play-icon, svg.pause-icon {
      width: 20px;
      height: 20px;
      display: block;
      fill: currentColor;
    }
  </style>
</head>
<body>
  <div id="playlist-container" aria-label="Tracklist"></div>
  <div id="footer-controls" aria-label="Global audio controls">
    <div class="footer-inner-container">
      <button class="btn-play-pause" aria-label="Play/Pause global audio player" title="Play/Pause global audio player"></button>
      <input type="range" min="0" max="1" step="0.01" value="1" aria-label="Volume control" />
    </div>
  </div>
<script>
  /* ========= Data Setup ========= */
  const musicData = [
    [
      "2025.08.10 - Jobo - Sunday.m4a",
      "Jobo",
      "Sunday",
      "2025.08.10",
      "Hip-Hop",
      2060,
      "01. DJ Solo - Soul Assassins Classic & Exclusive - 13 - Chronic Break - [Soul Assassins None] (2006)\n02. Cypress Hill - Latin Lingo - B1 - Stoned Is the Way of the Walk (LP Version) - [Ruffhouse 44.74478] (1992)\n03. Cypress Hill - Illusions - 1.04 - Illusions (Trumpet Instrumental) - [Ruffhouse XPR 2282] (1995)\n04. Call O' Da Wild - Sometimes the Neighborhood / Clouds of Smoke - B1 - Clouds of Smoke (Vocal) - [East Side BT195] (1995)\n05. Dredknotz - Causin’ a Menace / Tha Anthem - B2 - Tha Anthem (Remix Clean Version) - [Elektra ED 5689] (1994)\n06. Red Hot Lover Tone ft. Notorious B.I.G., Organized Konfusion & M.O.P. - 4 My Peeps (Remix Vocal - Dirty) - [Select PRCD 35] (1995)\n07. The Notorious B.I.G. - Party and Bullshit (Remix) - A1 - Party and Bullshit (Lord's Dirty) - [Uptown UPT8P 2753] (1993)\n08. Leaders of the New School - Spontaneous (13 MC's Deep) - (1993)",
      "iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAACmElEQVR4nAXBS4tcRRQA4HOqTlX1ffSd7puedtIjxIF0ZDABE0GDIkFxERBxI+LWrT/AX2LWWQSXQchOCFm5CRIMDIkJCeI4M+mensz07cfUfdStOn4f1r9f0zsKWLCTp7/sEfbw5tX4+o4gUx2twj8TYcr487x6PnUP/g6zAqffafVBnn42lFu9epbr0buUxuAUgADpmGsQrd1/4+88zPz6lEh0uFGPp4t7E8/jeHyJFEGtWCgQElqNjsBW8XbP3/7oxEL87TVSOkFp4h+/1F3J5yVQF8CCqwEZAIF6SCNwh9knA5vdjK4PyH8zbm3aH8e8sqgywAq4BF9Aeway5+oTFEbKWAInu7n9a0LJhyNUMSxPkJK2ObCrWVsv4tiYKLfzlwGS4F1kWp2976w6vf9CFI/2EUrmVbP8Y3XyJ3NLKogwAW6UYpYgTMS0BQEprs1WQhghiBKAQe1E3ar1jTYXtb7Cwel0xNUMBWqdgpsIwWo3JZEiBA/ste6BvMTsUeYAJcKSvTbpDQBm/x8iYrD9L3LSF0twAVCDSFl0QRC4w7J4GsBEHYOdywwGXAFyWU6b4sExVUUT5RY9QHiLagCh8vWZird90N4XvH4sKQtlgf1s9WSBT6ZU/Po2/bmrtHbrV55fA3DwpmzOQ+A0jQmsnR8l3c3mrHXPz81A4JtbEL7qbX8/DIvlfDGV0vSGHwfuMEspG64mEOYBRNtckCr36zWZ3cRn2fx42R+KC2rAvq2Xe63vMHPcqYUh58Tsrk2vDja+3qC1oI2fxjI3x78dHszONm8bE0UmDtKf+iAdkD2E8r6Ljs5d2A+33kEvSKL38xU/m9NeNX0JyQ+agdqD3E1q8163/+lmO9rHpYXpqvl33rky/B/+b1nmdaIQPgAAAABJRU5ErkJggg==",
      "[0.9956806121189683, 0.9934437862520055, 0.9884610638035296, 0.9914383561643836, 0.9785110452918672, 0.9895563371590769, 0.9741145254843885, 0.9726798716524744, 0.988630754041713, 0.9880599777860052, 0.9933512279402691, 0.9849129951869678, 0.9809792669381711, 0.975950265333827, 0.8227045538689375, 0.8119369369369369, 0.8763729482907565, 0.8435610267802048, 0.95379797605825, 0.8174904356411206, 0.7710415895347402, 0.7501234110823152, 0.7691287177588547, 0.981596322349747, 1.0, 0.9837405899049735, 0.6291034184869801, 0.6411514253980007, 0.8462914969764285, 0.972047389855609, 0.9104652597803283, 0.9575157349129952, 0.9819665555966925, 0.9413951622855733, 0.8605300505985437, 0.915401703072936, 0.8176446994940145, 0.7703628285820067, 0.7635289398988029, 0.8650345551030483, 0.7747593483894853, 0.9118382080710847, 0.9867641614216957, 0.7487967419474268, 0.753980007404665, 0.8160557818092065, 0.7224021967172652, 0.7956158213007528, 0.9569758114278663, 0.552465136369246]",
      "16766ca355943210e6f398fd4874a74f525933300a73db9e5220ba991acce7fa"
    ],
    [
      "2025.08.08 - Jobo - Rumskugel.m4a",
      "Jobo",
      "Rumskugel",
      "2025.08.08",
      "Bass, Dub-Step",
      2257,
      "",
      "iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAACv0lEQVR4nAXBy27TWAAAUN/re/24fttJnHchUDQZ1IqqoCIhsUDqkhVfwAfwUXwAe6TZTTdIMxJUQF+ZaeuS1CWxQxzbuX6bc8DfH//6cXX26cP7bVMEvMwinNdsxYu50siKYubOBoOh3R0apiHI+un5Cfrv5Mv8+GivZ0QxhckaCIQpoczERZVyWhNwdb9t33+8H0eeapp/jsfg3eGL6dlXXVX3R/bZjX//nm0r+Pp2JcgEEQ3zEhaRMX5aA5ZBGMkm2Bdgt2VWZbU3tKZBYnEgTMtRX2+3zRrywOzQ6UUpNokkJFE0PHwDnrQsHZRpno9UwW6oo62O64WXjku4um2oVkOTJIkzmiouPX+p9keQEKln6x1VHPb0yTycTBxDwi93B6au3Ib53HEWFEDATSfnKuFyfwF3LXwwkHmBS9P61d69z7P10fH/rreWQNXmIWXl8Od0evq1RpgmWV4WMPJ/OdNlSwRFknz89zKrGIRxlJXXcfXZ8Q0BMkUZ07DVMvOigkWMHG+DBd7EpaSIHUzwMjBw1TaIhrlv1x7Nc7OhAZa782lFY55j4c4fXaLIdttIk6TftMY6khVxkVT5fP5823KiKgxCu6GUDAw3OTRtZAgQIBRlxfFNvAPvfibFOqQPuuwqKYSqtCTl6MpzVpOtblPikHuzhE5QpsmGAObZQ11CcZDk16vNycxV5BppBoTAUkVFk1YRzapcJxUU+qPv0/WVu7y4Cy/9mvD8Tk9iOf7TxaosssUmB1nBZjQO1khtmdtPYEizB88OEpbzVpusqhuEmcwpZtierbtR5gVRECetwdDaGnWfHj56/RbRPL39VQ93D1J8ahHB924hUypE6LZMRZalRTBzF3Ng7R6+VBvG5dk/KMkozdMv5+tup59hJGDcE7T2+JHUfxjMvSi+6eyNeE3ZrH3NtkrA/QYbLl34UDP1qwAAAABJRU5ErkJggg==",
      "[0.6457995735607676, 0.6796588486140724, 0.6674626865671642, 0.7646908315565032, 0.7482985074626866, 0.6813475479744137, 0.6895181236673774, 0.6920767590618336, 0.630362473347548, 0.5033518123667378, 0.5343624733475479, 0.8160682302771854, 0.6257057569296375, 0.7574072494669509, 0.7301663113006397, 0.8186098081023454, 0.7974413646055437, 1.0, 0.8892622601279317, 0.7511300639658849, 0.8189850746268657, 0.7036588486140725, 0.539769722814499, 0.4458678038379531, 0.6937313432835821, 0.5106524520255864, 0.7861492537313433, 0.8399829424307036, 0.834456289978678, 0.9075309168443497, 0.6448955223880597, 0.7031982942430703, 0.6406652452025586, 0.8549765458422175, 0.42695095948827294, 0.7776034115138593, 0.7229339019189766, 0.6190874200426439, 0.7388656716417911, 0.8963752665245203, 0.7170490405117271, 0.5483496801705757, 0.43728784648187635, 0.6836503198294243, 0.6597014925373135, 0.541543710021322, 0.6548571428571428, 0.6040085287846482, 0.5853304904051173, 0.3951727078891258]",
      "15c91d58d2ef934c0a545f8a6d41b92c3e3dc7b7c4823f20b1e07063f22f1daf"
    ],
    [
      "2025.07.26 - Jobo - Neulich im Berghain.m4a",
      "Jobo",
      "Neulich im Berghain",
      "2025.07.26",
      "Techno",
      1605,
      "01. UR - The Final Frontier - 03 - Base Camp Alpha 808 - [Underground Resistance UR003] (1990)\n02. UR - The Final Frontier - 01 - The Final Frontier - [Underground Resistance UR003] (1990)\n03. Max Watts - Immortal Funk EP - A2 - Karma - [Limited Network LN008] (2023)\n04. Nomadico - The Code Switcha - C2 - Machine Learning for Homeboy - [Yaxteq YXTQ 004] (2018)\n05. Damon Wild - Avion Return Pt. 3 (EP) - 01 - Avion (A Paul Remix) - [Synewave SW100.2] (2011)\n06. Alex Bau - Repaints 5.5 (EP) - 06 - Full Method Jacket (Weston Prince Repaint) - [Credo CREDO15] (2010)\n07. Planetary Assault Systems - GT (Remixes) (EP) - B1 - GT (Function & Jerome Sydenham Remix) - [Mote-Evolver MOTE018] (2010)\n08. DJ Bone - Subject Detroit 30th Anniversary Remixes, Vol.1 - 1.06 - No Sleep (Jack Fresia Remix) - [Subject Detroit] (2025)\n09. UR - Interstellar Fugitives 2: Destruction of Order - 1.10 - DJ S2 - Post Emancipation Psychosis - [UWE UWE198] (2006)",
      "iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAACfUlEQVR4nGXSPW/kVBSA4XPuudfjj3E8no9sVizLpkGkoAE6GlokCvgp/AJKKgokKhpETYXYApSWggohoZUAsdkkk8xmkplxxuOxfe17z0Gpefu3e/D3P15MxvlknCVJDP9LBASkExZA5/2PP/2gT09/9c5prfIsncwmh4fT6WScjdIgDMZZhggIGCIBwMv5q+++/1p3bWOritnXRXF1fqGNAUAGeRjG008+/XiY5+fzq+FAvvjy88vLuSaQgdZgYgYyCArEs6urqm+trew333613FwsFvPWrpeLe/GBBoVKo6CAkChQROJUFA8RVRpHp7/98ur6nyiM9pXtGk0GtFboQBB6x5qIRBDAAYE4BKA4GZFK2obril3rgFCjiCHT9Y3fL604poM0YgfG2X3jivu7+7vrElgGgQKRNAh0ud2EaK5u5npx1jgzO3lrvbUMclD+9fxf2uvNyXsRdeadcPZ33b7/7FhvVq+7bbspV83ybsuhmybdbpfy7rY4e/Ey/OCj/MPPRsFt+ufzsjfdorC67dzl1XnDHYxyZrhcrp7OwtcwOL99dvRUP36UVteBXa/nF3fJk+hsdaOSI3P07jh8ww7i/exJFmRBsduk2e7kWJI4KBouVuV9p4o04Ly3cqtv6p8P8jenIZS7lVGCMAgzV9Zdp60aVbs90bBmpx6/jVFMnQs1M273F154eKAB1xhrNqz7Xno+PlTM3vpekJJHAkz5INBxlNRd7Trvexb2TtXKPrBDpeu2B0BhIgIQQHFIompb+p4JjYhSYrQ8+OAe2DsjCqwQA/eCgp7B9V43pYQhefTeeSQfGOg6RaJ86y170kSBMgoBBFE8w3/NyHU4AozYkwAAAABJRU5ErkJggg==",
      "[0.46528863530223963, 0.6298401998010111, 0.6473430932607769, 0.7424110134215923, 0.7063493674998477, 0.6912221567950618, 0.6098804036630185, 0.4438262705841743, 0.480659505776767, 0.5004162521066418, 0.5491888160165689, 0.4774716237893155, 0.40138886068752666, 0.6265507929095007, 0.59325062437816, 0.671181140733822, 0.8789620093809012, 0.8519969948628399, 0.8549006071189262, 0.8188592661779934, 0.4600905602144206, 0.56222461369774, 0.5829966090682044, 0.5451481248350221, 0.49060894637454566, 0.7481979329529533, 0.7828991451603078, 0.7389591666835875, 1.0, 0.8168693780584377, 0.7316290686105301, 0.6412312940364271, 0.6581859530142744, 0.765315031777295, 0.7342484111352515, 0.46262868281589475, 0.40587626144693295, 0.42317610509858067, 0.3473166967857215, 0.5854738167272432, 0.5930272695892302, 0.5819001401043676, 0.5831793538955106, 0.33190521634957054, 0.2955186907348373, 0.3146256776787346, 0.2891835367215578, 0.27123393368393267, 0.24605575747730918, 0.2611626632012833]",
      "a87681080790690e7a94c872c00c6a61b108bf9200a3f241102c85eb0e23d88e"
    ]
  ];
  /* ========= Global Constants & SVG Icons ========= */
  const playSVG = `<svg class="play-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><polygon points="6 4 20 12 6 20" /></svg>`;
  const pauseSVG = `<svg class="pause-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>`;

  /* ========= Accessibility & UX ========= */

  /**
   * Formats seconds to mm:ss string
   * Returns '0:00' if input falsy.
   */
  function formatTime(seconds) {
    if (!seconds) return '0:00';
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return `${m}:${s < 10 ? '0' : ''}${s}`;
  }

  /* ========= Waveform Drawing ========= */

  /**
   * Draws waveform bars on a given 2D canvas context.
   * Colors differ by play progress and hover state.
   * @param {CanvasRenderingContext2D} ctx - Canvas 2D context.
   * @param {Array<number>} ampData - normalized amplitude array (0..1).
   * @param {number} progress - fraction played (0..1).
   * @param {number} width - canvas width.
   * @param {number} height - canvas height.
   * @param {number} hoverIndex - waveform bar index hovered (-1 if none).
   * @param {boolean} isHovering - whether mouse is currently hovering.
   */
  function drawWaveform(ctx, ampData, progress, width, height, hoverIndex = -1, isHovering = false) {
    ctx.clearRect(0, 0, width, height);
    const midY = height / 2;
    const total = ampData.length;
    const barWidth = width / (total * 2);
    const spaceWidth = barWidth;

    for (let i = 0; i < total; i++) {
      const amp = ampData[i];
      const barHeight = amp * height;
      const x = i * (barWidth + spaceWidth);
      let fillStyle;

      if (isHovering && i === hoverIndex) {
        fillStyle = getComputedStyle(document.documentElement)
          .getPropertyValue('--waveform-hover').trim();
      } else if (i / total <= progress) {
        fillStyle = getComputedStyle(document.documentElement)
          .getPropertyValue('--waveform-active').trim();
      } else {
        fillStyle = getComputedStyle(document.documentElement)
          .getPropertyValue('--waveform-inactive').trim();
      }

      ctx.fillStyle = fillStyle;
      ctx.fillRect(x, midY - barHeight / 2, barWidth, barHeight);
    }
  }

  /* ========= UI Construction & Track Element Creation ========= */

  /**
   * Creates and returns a track DOM element with all UI components,
   * sets up event listeners for playback and waveform interaction.
   * @param {Array} data - musicData single track array.
   * @param {number} idx - track index in playlist.
   * @returns {object} track object containing references to components and audio functions.
   */
  function createTrackElement(data, idx) {
    // Main wrapper
    const trackElem = document.createElement('div');
    trackElem.className = 'track-item content';

    // 1. Cover Art Container
    const coverContainer = document.createElement('div');
    coverContainer.className = 'track-cover-container';
    const coverImg = document.createElement('img');
    coverImg.alt = `${data[2]} cover art`;
    coverImg.className = 'track-cover';
    coverImg.src = `data:image/png;base64,${data[7]}`;
    coverContainer.appendChild(coverImg);

    // 2. Info Container (flex row with 3 sections)
    const infoContainer = document.createElement('div');
    infoContainer.className = 'track-info-container';

    // 2.1 Play / Pause Button Container
    const playBtnContainer = document.createElement('div');
    playBtnContainer.className = 'play-btn-container';

    const playPauseBtn = document.createElement('button');
    playPauseBtn.className = 'btn-play-pause';
    playPauseBtn.setAttribute('aria-label', `Play or Pause ${data[2]} by ${data[1]}`);
    playPauseBtn.innerHTML = playSVG;
    playBtnContainer.appendChild(playPauseBtn);

    // 2.2 Artist & Title Container (stacked)
    const artistTitleContainer = document.createElement('div');
    artistTitleContainer.className = 'artist-title-container';

    const artistDiv = document.createElement('div');
    artistDiv.className = 'track-artist';
    artistDiv.textContent = data[1];

    const titleDiv = document.createElement('div');
    titleDiv.className = 'track-title';
    titleDiv.textContent = data[2];

    artistTitleContainer.appendChild(artistDiv);
    artistTitleContainer.appendChild(titleDiv);

    // 2.3 Meta Info Container - Genre & Date + Time Row
    const metaContainer = document.createElement('div');
    metaContainer.className = 'meta-info-container';

    // Genre and Date Row
    const genreDateRow = document.createElement('div');
    genreDateRow.className = 'genre-date-row';
    const genreDiv = document.createElement('div');
    genreDiv.className = 'track-genre';
    genreDiv.textContent = data[4];
    const dateDiv = document.createElement('div');
    dateDiv.className = 'track-date';
    dateDiv.textContent = data[3];
    genreDateRow.appendChild(genreDiv);
    genreDateRow.appendChild(dateDiv);

    // Time Row: current play time | separator | duration
    const timeRow = document.createElement('div');
    timeRow.className = 'time-row';
    const playPosDiv = document.createElement('div');
    playPosDiv.className = 'play-pos';
    playPosDiv.textContent = '0:00';
    const sepDiv = document.createElement('div');
    sepDiv.className = 'separator';
    sepDiv.textContent = '|';
    const durDiv = document.createElement('div');
    durDiv.className = 'duration';
    durDiv.textContent = formatTime(data[5]);
    timeRow.appendChild(playPosDiv);
    timeRow.appendChild(sepDiv);
    timeRow.appendChild(durDiv);

    metaContainer.appendChild(genreDateRow);
    metaContainer.appendChild(timeRow);

    // Append all 3 info subcontainers
    infoContainer.appendChild(playBtnContainer);
    infoContainer.appendChild(artistTitleContainer);
    infoContainer.appendChild(metaContainer);

    // 3. Waveform Container - canvas for visualization
    const waveformContainer = document.createElement('div');
    waveformContainer.className = 'waveform-container';
    const waveformCanvas = document.createElement('canvas');
    waveformCanvas.className = 'waveform-canvas';
    waveformCanvas.width = 600;
    waveformCanvas.height = 110;
    waveformContainer.appendChild(waveformCanvas);

    // 4. Tracklist Toggle Container (optional tracklist)
    const tracklistContainer = document.createElement('div');
    tracklistContainer.className = 'tracklist-container';

    let toggleBtn = null;
    let tracklistContent = null;
    if (data[6].trim() !== '') {
      toggleBtn = document.createElement('button');
      toggleBtn.className = 'btn-toggle-tracklist';
      toggleBtn.setAttribute('aria-expanded', 'false');
      toggleBtn.textContent = 'Tracklist';
      toggleBtn.addEventListener('click', () => {
        const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
        toggleBtn.setAttribute('aria-expanded', expanded ? 'false' : 'true');
        tracklistContent.classList.toggle('visible');
      });
      tracklistContent = document.createElement('pre');
      tracklistContent.className = 'tracklist-content';
      tracklistContent.textContent = data[6];
      tracklistContainer.appendChild(toggleBtn);
      tracklistContainer.appendChild(tracklistContent);
    }

    // Append all main containers into track item
    trackElem.appendChild(coverContainer);
    trackElem.appendChild(infoContainer);
    trackElem.appendChild(waveformContainer);
    if (tracklistContainer.childNodes.length > 0) {
      trackElem.appendChild(tracklistContainer);
    }

    /* ========= Audio Streaming & Playback Control ========= */

    // Create hidden audio element for fallback streaming
    const audioElement = document.createElement('audio');
    audioElement.src = `music/${data[0]}`;
    audioElement.preload = 'metadata';
    audioElement.style.display = 'none';
    audioElement.controls = false;
    trackElem.appendChild(audioElement);

    // Waveform drawing context and metadata
    const ctx = waveformCanvas.getContext('2d');
    const width = waveformCanvas.width;
    const height = waveformCanvas.height;
    const ampData = JSON.parse(data[8]);
    const duration = data[5];

    // Draw initial waveform with zero progress
    drawWaveform(ctx, ampData, 0, width, height);

    /* ========= Playback Progress Updates & Waveform Interaction ========= */

    // State vars to handle waveform interaction
    let mouseHovering = false;
    let hoverIndex = -1;

    // Update waveform, time display as audio plays (unless hovering)
    audioElement.addEventListener('timeupdate', () => {
      if (!mouseHovering) {
        const current = audioElement.currentTime;
        const dur = audioElement.duration || duration;
        const prog = dur ? current / dur : 0;
        drawWaveform(ctx, ampData, prog, width, height);
        playPosDiv.textContent = formatTime(current);
        durDiv.textContent = formatTime(dur);
      }
    });

    // On track end, reset UI and play next track
    audioElement.addEventListener('ended', () => {
      playPauseBtn.innerHTML = playSVG;
      if (playingIndex === idx) {
        playingIndex = -1;
        updateFooter(null, null, -1);
        playNextTrack(idx);
      }
    });

    // Play/Pause button toggles playback state for this track
    playPauseBtn.addEventListener('click', () => {
      if (audioElement.paused) {
        // Pause all other track audios
        tracks.forEach(({ audio, btnPlay }, i) => {
          if (i !== idx) {
            audio?.pause();
            btnPlay.innerHTML = playSVG;
          }
        });
        audioElement.play();
        playPauseBtn.innerHTML = pauseSVG;
        playingIndex = idx;
        updateFooter(audioElement, playPauseBtn, idx);
      } else {
        audioElement.pause();
        playPauseBtn.innerHTML = playSVG;
        if (playingIndex === idx) playingIndex = -1;
        updateFooter(null, null, -1);
      }
    });

    // Clicking waveform seeks playback position
    waveformCanvas.addEventListener('click', e => {
      const rect = waveformCanvas.getBoundingClientRect();
      const ratio = (e.clientX - rect.left) / rect.width;
      const dur = audioElement.duration || duration;
      audioElement.currentTime = ratio * dur;
      drawWaveform(ctx, ampData, ratio, width, height);
    });

    // Hovering waveform shows hover time, highlights bar
    waveformCanvas.addEventListener('mousemove', e => {
      mouseHovering = true;
      const rect = waveformCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const ratio = x / rect.width;
      hoverIndex = Math.min(Math.max(Math.floor(ratio * ampData.length), 0), ampData.length - 1);
      const dur = audioElement.duration || duration;
      playPosDiv.textContent = formatTime(ratio * dur);
      durDiv.textContent = formatTime(dur);
      const prog = audioElement.currentTime / dur;
      drawWaveform(ctx, ampData, prog, width, height, hoverIndex, true);
    });

    // Leaving waveform resets to current playback time display & bar
    waveformCanvas.addEventListener('mouseleave', () => {
      mouseHovering = false;
      hoverIndex = -1;
      const dur = audioElement.duration || duration;
      const curTime = audioElement.currentTime;
      const prog = dur ? curTime / dur : 0;
      drawWaveform(ctx, ampData, prog, width, height);
      playPosDiv.textContent = formatTime(curTime);
      durDiv.textContent = formatTime(dur);
    });

    // Return track object with references & control functions
    return {
      container: trackElem,
      audio: audioElement,
      btnPlay: playPauseBtn,
      timeDisplay: timeRow,
      canvasCtx: ctx,
      ampData,
      width,
      height,
      currentTimeFn: () => audioElement.currentTime,
      playAudioFn: () => audioElement.play(),
      pauseAudioFn: () => audioElement.pause()
    };
  }

  /* ========= Global State Management & Playback Control ========= */

  const tracks = [];
  let playingIndex = -1;

  const footerPlayBtn = document.querySelector('#footer-controls .btn-play-pause');
  const footerVolumeInput = document.querySelector('#footer-controls input[type="range"]');

  /**
   * Updates the global footer controls:
   * - Synchronizes play/pause icon and state
   * - Associates global controls with the active track
   * - Adjusts volume slider fill percentage
   * @param {HTMLAudioElement|null} audio - currently playing audio or null if none.
   * @param {HTMLButtonElement|null} playBtn - corresponding play button or null.
   * @param {number} idx - current track index or -1 if none.
   */
  function updateFooter(audio, playBtn, idx) {
    if (audio || playBtn) {
      const paused = audio ? audio.paused : playBtn.innerHTML === playSVG;
      footerPlayBtn.innerHTML = paused ? playSVG : pauseSVG;
      footerPlayBtn.disabled = false;
      footerPlayBtn._linkedAudio = audio;
      footerPlayBtn._linkedPlayBtn = playBtn;
      footerPlayBtn._linkedIndex = idx;
      if (audio) footerVolumeInput.value = audio.volume;
      updateVolumeBar(audio ? audio.volume : 1);
    } else {
      footerPlayBtn.innerHTML = playSVG;
      footerPlayBtn.disabled = true;
      footerPlayBtn._linkedAudio = null;
      footerPlayBtn._linkedPlayBtn = null;
      footerPlayBtn._linkedIndex = -1;
      updateVolumeBar(1);
    }
  }

  /**
   * Updates the CSS variable controlling volume slider's filled track
   * @param {number} volume - value between 0 and 1
   */
  function updateVolumeBar(volume) {
    const perc = Math.round(volume * 100);
    footerVolumeInput.style.setProperty('--vol-percent', perc + '%');
  }

  /**
   * Plays the next track in the playlist, if any.
   * Pauses all other tracks.
   * Scrolls the new track into vertical center view if not fully visible.
   * @param {number} currentIndex - index of the track that just ended.
   */
  function playNextTrack(currentIndex) {
    let nextIdx = currentIndex + 1;
    if (nextIdx >= tracks.length) {
      updateFooter(null, null, -1);
      return; // No more tracks
    }
    const { audio, btnPlay, container } = tracks[nextIdx];
    tracks.forEach(({ audio: a, btnPlay: b }) => {
      if (a && a !== audio) {
        a.pause();
        b.innerHTML = playSVG;
      }
    });
    audio.currentTime = 0;
    audio.play();
    btnPlay.innerHTML = pauseSVG;
    playingIndex = nextIdx;
    updateFooter(audio, btnPlay, nextIdx);

    // Scroll track element into vertical center of viewport if not fully visible
    const bounding = container.getBoundingClientRect();
    const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
    const isFullyVisible = bounding.top >= 0 && bounding.bottom <= viewportHeight;
    if (!isFullyVisible) {
      const scrollToY = window.scrollY + bounding.top - (viewportHeight / 2) + (bounding.height / 2);
      window.scrollTo({
        top: scrollToY,
        behavior: 'smooth'
      });
    }
  }

  /* ========= Global Footer Controls Event Handlers ========= */

  // Global footer play/pause button toggles currently playing track
  footerPlayBtn.addEventListener('click', () => {
    const audio = footerPlayBtn._linkedAudio;
    const playBtn = footerPlayBtn._linkedPlayBtn;
    if (!audio) return;

    if (audio.paused) {
      // Pause all other tracks except this one
      tracks.forEach(({ audio: a, btnPlay: b }) => {
        if (a && a !== audio) {
          a.pause();
          b.innerHTML = playSVG;
        }
      });
      audio.play();
      playBtn.innerHTML = pauseSVG;
      footerPlayBtn.innerHTML = pauseSVG;
    } else {
      audio.pause();
      playBtn.innerHTML = playSVG;
      footerPlayBtn.innerHTML = playSVG;
    }
  });

  // Volume slider input event updates all track volumes
  footerVolumeInput.addEventListener('input', e => {
    const vol = parseFloat(e.target.value);
    tracks.forEach(({ audio }) => {
      if (audio) audio.volume = vol;
    });
    updateVolumeBar(vol);
  });

  // Volume slider mouse wheel controls volume in steps
  footerVolumeInput.addEventListener('wheel', e => {
    e.preventDefault();
    const delta = e.deltaY || e.detail || e.wheelDelta;
    const step = 0.05;
    let vol = parseFloat(footerVolumeInput.value);

    vol += delta < 0 ? step : -step;
    vol = Math.min(1, Math.max(0, vol));
    footerVolumeInput.value = vol;
    tracks.forEach(({ audio }) => {
      if (audio) audio.volume = vol;
    });
    updateVolumeBar(vol);
  }, { passive: false });

  /* ========= Keyboard Shortcut Handlers ========= */

  // Keyboard shortcuts for playback skip (left/right arrows)
  window.addEventListener('keydown', e => {
    if (playingIndex === -1) return;
    const currentAudio = tracks[playingIndex]?.audio;
    if (!currentAudio) return;

    const skipSmall = 10; // seconds for normal arrow keys
    const skipLarge = 60; // seconds for ctrl + arrow keys

    if (e.code === 'ArrowRight' || e.code === 'ArrowLeft') {
      e.preventDefault();
      const direction = e.code === 'ArrowRight' ? 1 : -1;
      const skipAmount = e.ctrlKey ? skipLarge : skipSmall;
      let newTime = currentAudio.currentTime + direction * skipAmount;

      if (newTime < 0) newTime = 0;
      if (currentAudio.duration && newTime > currentAudio.duration) newTime = currentAudio.duration;

      currentAudio.currentTime = newTime;
    }
  });

  /* ========= Initialization & Lifecycle ========= */

  const playlistRoot = document.getElementById('playlist-container');

  // Create UI, track objects and append to playlist
  musicData.forEach((trackData, i) => {
    const trackObj = createTrackElement(trackData, i);
    tracks.push(trackObj);
    playlistRoot.appendChild(trackObj.container);
  });

  // Initialize footer play button icon and volume bar
  footerPlayBtn.innerHTML = playSVG;
  updateVolumeBar(1);

  // Pause all audio on page unload for clean exit
  window.addEventListener('pagehide', () => {
    tracks.forEach(({ audio }) => {
      audio?.pause();
    });
  });
</script>
</body>
</html>
